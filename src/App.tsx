import React, { useState, useEffect, useCallback } from 'react';\nimport './App.css';\nimport WalletConnection from './components/WalletConnection';\nimport ContractInfo from './components/ContractInfo';\nimport EnvelopeCreator from './components/EnvelopeCreator';\nimport EnvelopeViewer from './components/EnvelopeViewer';\nimport { useWallet } from './hooks/useWallet';\nimport { useContract } from './hooks/useContract';\n\nconst App: React.FC = () => {\n  const { account, provider, isConnecting, connectWallet, disconnectWallet } = useWallet();\n  const { \n    loading, \n    createEnvelope, \n    claimEnvelope, \n    getEnvelope, \n    hasUserClaimed, \n    getTotalEnvelopes,\n    contractAddress \n  } = useContract(provider);\n  \n  const [totalEnvelopes, setTotalEnvelopes] = useState<number>(0);\n  const [lastUpdateTime, setLastUpdateTime] = useState<number>(Date.now());\n\n  // 获取红包总数\n  const fetchTotalEnvelopes = useCallback(async () => {\n    if (provider) {\n      try {\n        const total = await getTotalEnvelopes();\n        setTotalEnvelopes(total);\n      } catch (error) {\n        console.error('获取红包总数失败:', error);\n      }\n    }\n  }, [provider, getTotalEnvelopes]);\n\n  useEffect(() => {\n    fetchTotalEnvelopes();\n  }, [fetchTotalEnvelopes, lastUpdateTime]);\n\n  const handleCreateEnvelope = async () => {\n    try {\n      const txHash = await createEnvelope();\n      if (txHash) {\n        alert(`红包创建成功！\\n交易哈希: ${txHash}`);\n        setLastUpdateTime(Date.now()); // 触发数据刷新\n      }\n    } catch (error: any) {\n      console.error('创建红包失败:', error);\n      let errorMessage = '创建红包失败，请重试';\n      \n      if (error.message?.includes('insufficient funds') || error.message?.includes('余额不足')) {\n        errorMessage = '余额不足，需要至少 0.05 ETH + Gas费';\n      } else if (error.message?.includes('user rejected') || error.message?.includes('用户取消')) {\n        errorMessage = '用户取消了交易';\n      } else if (error.message?.includes('请先连接钱包')) {\n        errorMessage = '请先连接 MetaMask 钱包';\n      }\n      \n      alert(errorMessage);\n    }\n  };\n\n  const handleClaimEnvelope = async (envelopeId: number) => {\n    try {\n      const result = await claimEnvelope(envelopeId);\n      if (result) {\n        setLastUpdateTime(Date.now()); // 触发数据刷新\n      }\n      return result;\n    } catch (error: any) {\n      console.error('抢红包失败:', error);\n      // 让 EnvelopeViewer 组件处理具体的错误显示\n      throw error;\n    }\n  };\n\n  const handleGetEnvelope = useCallback(async (envelopeId: number) => {\n    return await getEnvelope(envelopeId);\n  }, [getEnvelope]);\n\n  const handleHasUserClaimed = useCallback(async (envelopeId: number, userAddress: string) => {\n    return await hasUserClaimed(envelopeId, userAddress);\n  }, [hasUserClaimed]);\n\n  return (\n    <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' }}>\n      {/* Header */}\n      <div style={{\n        background: 'rgba(255, 255, 255, 0.1)',\n        backdropFilter: 'blur(10px)',\n        borderBottom: '1px solid rgba(255, 255, 255, 0.2)'\n      }}>\n        <div style={{\n          display: 'flex',\n          justifyContent: 'space-between',\n          alignItems: 'center',\n          padding: '0 20px'\n        }}>\n          <h1 style={{\n            color: 'white',\n            margin: '20px 0',\n            fontSize: '28px',\n            fontWeight: 'bold'\n          }}>\n            🧧 智能合约红包系统\n          </h1>\n          <WalletConnection\n            account={account}\n            isConnecting={isConnecting}\n            onConnect={connectWallet}\n            onDisconnect={disconnectWallet}\n          />\n        </div>\n      </div>\n\n      {/* Main Content */}\n      <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '0 20px' }}>\n        {account ? (\n          <>\n            <ContractInfo \n              contractAddress={contractAddress}\n              totalEnvelopes={totalEnvelopes}\n            />\n            \n            <div style={{ \n              display: 'grid', \n              gridTemplateColumns: 'repeat(auto-fit, minmax(500px, 1fr))', \n              gap: '20px',\n              margin: '20px 0'\n            }} className=\"grid-responsive\">\n              <EnvelopeCreator\n                onCreateEnvelope={handleCreateEnvelope}\n                loading={loading}\n              />\n              \n              <EnvelopeViewer\n                onQueryEnvelope={handleGetEnvelope}\n                onClaimEnvelope={handleClaimEnvelope}\n                onCheckClaimed={handleHasUserClaimed}\n                userAddress={account}\n                loading={loading}\n              />\n            </div>\n          </>\n        ) : (\n          <div style={{\n            textAlign: 'center',\n            padding: '100px 20px',\n            color: 'white'\n          }}>\n            <div style={{\n              background: 'rgba(255, 255, 255, 0.1)',\n              backdropFilter: 'blur(10px)',\n              borderRadius: '20px',\n              padding: '50px',\n              maxWidth: '600px',\n              margin: '0 auto'\n            }} className=\"fade-in\">\n              <h2 style={{ fontSize: '48px', margin: '0 0 20px 0' }}>🧧</h2>\n              <h2 style={{ marginBottom: '20px' }}>欢迎使用智能合约红包系统</h2>\n              <p style={{ fontSize: '18px', lineHeight: '1.6', marginBottom: '30px' }}>\n                基于以太坊智能合约的去中心化红包系统<br/>\n                支持创建红包、随机分配金额、抢红包等功能\n              </p>\n              <div style={{ fontSize: '16px', color: '#ddd', marginBottom: '30px' }}>\n                🎯 每个红包包含 6 个随机金额的子包<br/>\n                💰 固定总金额 0.05 ETH<br/>\n                🎲 完全随机分配，公平公正<br/>\n                🔒 智能合约保证安全性\n              </div>\n              <p style={{ fontSize: '16px', color: '#f39c12' }}>\n                请先连接您的 MetaMask 钱包开始使用\n              </p>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Footer */}\n      <div style={{\n        textAlign: 'center',\n        padding: '40px 20px',\n        color: 'rgba(255, 255, 255, 0.7)',\n        fontSize: '14px'\n      }}>\n        <p>🚀 Red Envelope DApp - 基于区块链的智能红包系统</p>\n        <p>⚠️ 仅供学习和测试使用，请在测试网络中进行测试</p>\n      </div>\n    </div>\n  );\n};\n\nexport default App;