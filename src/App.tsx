import React, { useState, useEffect, useCallback } from 'react';\nimport './App.css';\nimport WalletConnection from './components/WalletConnection';\nimport ContractInfo from './components/ContractInfo';\nimport EnvelopeCreator from './components/EnvelopeCreator';\nimport EnvelopeViewer from './components/EnvelopeViewer';\nimport { useWallet } from './hooks/useWallet';\nimport { useContract } from './hooks/useContract';\n\nconst App: React.FC = () => {\n  const { account, provider, isConnecting, connectWallet, disconnectWallet } = useWallet();\n  const { \n    loading, \n    createEnvelope, \n    claimEnvelope, \n    getEnvelope, \n    hasUserClaimed, \n    getTotalEnvelopes,\n    contractAddress \n  } = useContract(provider);\n  \n  const [totalEnvelopes, setTotalEnvelopes] = useState<number>(0);\n  const [lastUpdateTime, setLastUpdateTime] = useState<number>(Date.now());\n\n  // è·å–çº¢åŒ…æ€»æ•°\n  const fetchTotalEnvelopes = useCallback(async () => {\n    if (provider) {\n      try {\n        const total = await getTotalEnvelopes();\n        setTotalEnvelopes(total);\n      } catch (error) {\n        console.error('è·å–çº¢åŒ…æ€»æ•°å¤±è´¥:', error);\n      }\n    }\n  }, [provider, getTotalEnvelopes]);\n\n  useEffect(() => {\n    fetchTotalEnvelopes();\n  }, [fetchTotalEnvelopes, lastUpdateTime]);\n\n  const handleCreateEnvelope = async () => {\n    try {\n      const txHash = await createEnvelope();\n      if (txHash) {\n        alert(`çº¢åŒ…åˆ›å»ºæˆåŠŸï¼\\näº¤æ˜“å“ˆå¸Œ: ${txHash}`);\n        setLastUpdateTime(Date.now()); // è§¦å‘æ•°æ®åˆ·æ–°\n      }\n    } catch (error: any) {\n      console.error('åˆ›å»ºçº¢åŒ…å¤±è´¥:', error);\n      let errorMessage = 'åˆ›å»ºçº¢åŒ…å¤±è´¥ï¼Œè¯·é‡è¯•';\n      \n      if (error.message?.includes('insufficient funds') || error.message?.includes('ä½™é¢ä¸è¶³')) {\n        errorMessage = 'ä½™é¢ä¸è¶³ï¼Œéœ€è¦è‡³å°‘ 0.05 ETH + Gasè´¹';\n      } else if (error.message?.includes('user rejected') || error.message?.includes('ç”¨æˆ·å–æ¶ˆ')) {\n        errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';\n      } else if (error.message?.includes('è¯·å…ˆè¿æ¥é’±åŒ…')) {\n        errorMessage = 'è¯·å…ˆè¿æ¥ MetaMask é’±åŒ…';\n      }\n      \n      alert(errorMessage);\n    }\n  };\n\n  const handleClaimEnvelope = async (envelopeId: number) => {\n    try {\n      const result = await claimEnvelope(envelopeId);\n      if (result) {\n        setLastUpdateTime(Date.now()); // è§¦å‘æ•°æ®åˆ·æ–°\n      }\n      return result;\n    } catch (error: any) {\n      console.error('æŠ¢çº¢åŒ…å¤±è´¥:', error);\n      // è®© EnvelopeViewer ç»„ä»¶å¤„ç†å…·ä½“çš„é”™è¯¯æ˜¾ç¤º\n      throw error;\n    }\n  };\n\n  const handleGetEnvelope = useCallback(async (envelopeId: number) => {\n    return await getEnvelope(envelopeId);\n  }, [getEnvelope]);\n\n  const handleHasUserClaimed = useCallback(async (envelopeId: number, userAddress: string) => {\n    return await hasUserClaimed(envelopeId, userAddress);\n  }, [hasUserClaimed]);\n\n  return (\n    <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' }}>\n      {/* Header */}\n      <div style={{\n        background: 'rgba(255, 255, 255, 0.1)',\n        backdropFilter: 'blur(10px)',\n        borderBottom: '1px solid rgba(255, 255, 255, 0.2)'\n      }}>\n        <div style={{\n          display: 'flex',\n          justifyContent: 'space-between',\n          alignItems: 'center',\n          padding: '0 20px'\n        }}>\n          <h1 style={{\n            color: 'white',\n            margin: '20px 0',\n            fontSize: '28px',\n            fontWeight: 'bold'\n          }}>\n            ğŸ§§ æ™ºèƒ½åˆçº¦çº¢åŒ…ç³»ç»Ÿ\n          </h1>\n          <WalletConnection\n            account={account}\n            isConnecting={isConnecting}\n            onConnect={connectWallet}\n            onDisconnect={disconnectWallet}\n          />\n        </div>\n      </div>\n\n      {/* Main Content */}\n      <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '0 20px' }}>\n        {account ? (\n          <>\n            <ContractInfo \n              contractAddress={contractAddress}\n              totalEnvelopes={totalEnvelopes}\n            />\n            \n            <div style={{ \n              display: 'grid', \n              gridTemplateColumns: 'repeat(auto-fit, minmax(500px, 1fr))', \n              gap: '20px',\n              margin: '20px 0'\n            }} className=\"grid-responsive\">\n              <EnvelopeCreator\n                onCreateEnvelope={handleCreateEnvelope}\n                loading={loading}\n              />\n              \n              <EnvelopeViewer\n                onQueryEnvelope={handleGetEnvelope}\n                onClaimEnvelope={handleClaimEnvelope}\n                onCheckClaimed={handleHasUserClaimed}\n                userAddress={account}\n                loading={loading}\n              />\n            </div>\n          </>\n        ) : (\n          <div style={{\n            textAlign: 'center',\n            padding: '100px 20px',\n            color: 'white'\n          }}>\n            <div style={{\n              background: 'rgba(255, 255, 255, 0.1)',\n              backdropFilter: 'blur(10px)',\n              borderRadius: '20px',\n              padding: '50px',\n              maxWidth: '600px',\n              margin: '0 auto'\n            }} className=\"fade-in\">\n              <h2 style={{ fontSize: '48px', margin: '0 0 20px 0' }}>ğŸ§§</h2>\n              <h2 style={{ marginBottom: '20px' }}>æ¬¢è¿ä½¿ç”¨æ™ºèƒ½åˆçº¦çº¢åŒ…ç³»ç»Ÿ</h2>\n              <p style={{ fontSize: '18px', lineHeight: '1.6', marginBottom: '30px' }}>\n                åŸºäºä»¥å¤ªåŠæ™ºèƒ½åˆçº¦çš„å»ä¸­å¿ƒåŒ–çº¢åŒ…ç³»ç»Ÿ<br/>\n                æ”¯æŒåˆ›å»ºçº¢åŒ…ã€éšæœºåˆ†é…é‡‘é¢ã€æŠ¢çº¢åŒ…ç­‰åŠŸèƒ½\n              </p>\n              <div style={{ fontSize: '16px', color: '#ddd', marginBottom: '30px' }}>\n                ğŸ¯ æ¯ä¸ªçº¢åŒ…åŒ…å« 6 ä¸ªéšæœºé‡‘é¢çš„å­åŒ…<br/>\n                ğŸ’° å›ºå®šæ€»é‡‘é¢ 0.05 ETH<br/>\n                ğŸ² å®Œå…¨éšæœºåˆ†é…ï¼Œå…¬å¹³å…¬æ­£<br/>\n                ğŸ”’ æ™ºèƒ½åˆçº¦ä¿è¯å®‰å…¨æ€§\n              </div>\n              <p style={{ fontSize: '16px', color: '#f39c12' }}>\n                è¯·å…ˆè¿æ¥æ‚¨çš„ MetaMask é’±åŒ…å¼€å§‹ä½¿ç”¨\n              </p>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Footer */}\n      <div style={{\n        textAlign: 'center',\n        padding: '40px 20px',\n        color: 'rgba(255, 255, 255, 0.7)',\n        fontSize: '14px'\n      }}>\n        <p>ğŸš€ Red Envelope DApp - åŸºäºåŒºå—é“¾çš„æ™ºèƒ½çº¢åŒ…ç³»ç»Ÿ</p>\n        <p>âš ï¸ ä»…ä¾›å­¦ä¹ å’Œæµ‹è¯•ä½¿ç”¨ï¼Œè¯·åœ¨æµ‹è¯•ç½‘ç»œä¸­è¿›è¡Œæµ‹è¯•</p>\n      </div>\n    </div>\n  );\n};\n\nexport default App;