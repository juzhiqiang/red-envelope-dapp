# 钱包切换功能修复说明

## 问题描述
原有的钱包切换功能使用了不稳定的方法，导致切换失败。

## 解决方案

### 1. 多重切换策略
实现了三种不同的切换方法，按优先级依次尝试：

**方法1：直接切换账户**
```javascript
await window.ethereum.request({
  method: 'wallet_switchEthereumAccount',
  params: [{ address: selectedAccount }]
});
```

**方法2：重新请求权限**
```javascript
await window.ethereum.request({
  method: 'wallet_requestPermissions',
  params: [{ eth_accounts: {} }]
});
```

**方法3：用户手动切换**
如果前两种方法都失败，提示用户在 MetaMask 中手动切换账户。

### 2. 改进的状态管理

#### 在 `useWallet.ts` 中：
- 新增 `updateAccount` 方法用于手动设置账户
- 导出 `setAccount` 方法供外部调用
- 改进账户变化监听逻辑

#### 在 `WalletConnection.tsx` 中：
- 新增 `onAccountChange` 回调属性
- 添加切换状态指示（`isSwitching`）
- 改进错误处理和用户反馈

#### 在 `App.tsx` 中：
- 新增 `handleAccountChange` 回调函数
- 自动触发数据重新加载

### 3. 用户体验改进

#### 视觉反馈：
- 切换过程中显示加载动画
- 禁用切换按钮防止重复操作
- 提供清晰的状态提示

#### 错误处理：
- 友好的错误提示消息
- 多种切换方法的回退机制
- 手动切换的指导提示

#### 状态同步：
- 账户切换后自动刷新数据
- 同步更新 ENS 信息
- 更新可用账户列表

## 使用方法

### 自动切换
1. 点击已连接的钱包卡片
2. 在下拉菜单中选择要切换的账户
3. 系统会自动尝试切换，成功后界面会立即更新

### 手动切换
如果自动切换失败：
1. 直接在 MetaMask 中选择目标账户
2. 页面会自动检测账户变化并更新

## 技术实现细节

### 切换流程
```
用户点击切换 → 尝试直接切换 → 失败则请求权限 → 失败则提示手动切换
```

### 状态更新
```
账户变化 → 更新状态 → 刷新数据 → 更新 UI
```

### 兼容性
- 支持所有现代浏览器
- 兼容不同版本的 MetaMask
- 适配各种网络环境

## 注意事项

1. **网络权限**：某些网络可能不支持自动切换
2. **MetaMask 版本**：建议使用最新版本的 MetaMask
3. **用户授权**：切换需要用户确认授权
4. **数据同步**：切换后会自动重新加载相关数据

## 调试信息

如果切换仍然失败，可以检查浏览器控制台的错误信息：
- 权限被拒绝
- 网络连接问题
- MetaMask 状态异常

建议在这种情况下刷新页面或重新连接钱包。